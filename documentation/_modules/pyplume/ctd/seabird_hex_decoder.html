<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyplume.ctd.seabird_hex_decoder &mdash; pyplume  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
    <link rel="shortcut icon" href="../../../_static/logo.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            pyplume
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../API.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pd0%20Dataset.html"><strong>Pd0 Dataset</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ctd%20Dataset.html"><strong>CTD Dataset</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Pose.html"><strong>Pose</strong></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Data%20Manager.html"><strong>Data Manager</strong></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyplume</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyplume.ctd.seabird_hex_decoder</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyplume.ctd.seabird_hex_decoder</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon May 15 15:35:53 2023</span>

<span class="sd">@author: sndn</span>


<span class="sd">to do </span>

<span class="sd">method to efficiently sceen the file by only parsing header info</span>
<span class="sd">add position data and other metadata to csv output</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">###############################################################################</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>


<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">LineCollection</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mticker</span>


<span class="kn">import</span> <span class="nn">copy</span>


<span class="kn">from</span> <span class="nn">..ptools</span> <span class="kn">import</span> <span class="n">ptools</span>
<span class="kn">from</span> <span class="nn">..plotting.matplotlib_shell</span> <span class="kn">import</span> <span class="n">subplots</span><span class="p">,</span> <span class="n">dhi_colors</span>


<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="c1">###############################################################################</span>

<div class="viewcode-block" id="seabird_ctd">
<a class="viewcode-back" href="../../../pyplume.ctd.html#pyplume.ctd.seabird_hex_decoder.seabird_ctd">[docs]</a>
<span class="k">class</span> <span class="nc">seabird_ctd</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath_hex</span><span class="p">,</span> <span class="n">filepath_xml</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_filepath_hex</span> <span class="o">=</span> <span class="n">filepath_hex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filepath_xml</span> <span class="o">=</span> <span class="n">filepath_xml</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">import_file</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;import_file&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">import_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__detect_sensors</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__parse_xml</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__parse_hex</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__detect_sensors</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__parse_xml</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__parse_hex</span><span class="p">()</span>
            
            
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__print_metadata</span><span class="p">()</span>   <span class="c1"># Comment out to mute metadata</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">__get_xml_coefficients</span><span class="p">()</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__get_hex_coefficients</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__compare_coefficients</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="kc">None</span>
                <span class="c1">#print(&#39;No hex coefficients found&#39;)</span>
            
            
            <span class="bp">self</span><span class="o">.</span><span class="n">__hex2temperature</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__hex2pressure</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__hex2conductivity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__conductivity2salinity</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="s1">&#39;TurbidityMeter&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sensors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__hex2turbidity</span><span class="p">()</span>
                
            <span class="k">if</span> <span class="s1">&#39;WET_LabsCStar&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sensors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__hex2transmission</span><span class="p">()</span>
                
            <span class="k">if</span> <span class="s1">&#39;OxygenSensor&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sensors</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__hex2oxygen</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">__detect_sensors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Detects all instruments found in the xml configuration file (.xmlcon) and stores their names in self._sensors</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_index</span> <span class="o">=</span> <span class="p">{}</span>
        
        
        
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath_xml</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="n">sensors</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Instrument/SensorArray/Sensor&#39;</span><span class="p">)</span>
        
        <span class="c1">#get number of external voltage channels </span>
        <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Instrument/ExternalVoltageChannels&#39;</span><span class="p">):</span>
            <span class="n">n_ext_sensors</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Instrument/ExternalVoltageChannels&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_ext_sensors</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">sensor_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="n">sensors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">sensor</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s1">&#39;NotInUse&#39;</span><span class="p">:</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sensors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
                    
                    
                    <span class="c1"># set sensor index in order read from file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_index</span><span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensor_idx</span>
                    <span class="n">sensor_idx</span> <span class="o">+=</span><span class="mi">1</span>
                    
    <span class="k">def</span> <span class="nf">__print_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Prints file metadata to standard output (terminal)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#################### Seabird CTD Hex File ####################</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[4m&quot;</span> <span class="o">+</span> <span class="s1">&#39;METADATA&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[4m&quot;</span> <span class="o">+</span> <span class="s1">&#39;Instrument name&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_xmlcon</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[4m&quot;</span> <span class="o">+</span> <span class="s1">&#39;File name&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath_hex</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[4m&quot;</span> <span class="o">+</span> <span class="s1">&#39;File size&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath_hex</span><span class="p">)</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1"> bytes&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[4m&quot;</span> <span class="o">+</span> <span class="s1">&#39;Number samples&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    &#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[4m&quot;</span> <span class="o">+</span> <span class="s1">&#39;Attached sensors&#39;</span><span class="o">+</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sensors</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;        </span><span class="si">{</span><span class="n">sensor</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">__parse_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Extracts information from the xml configuration file (.xmlcon) and stores it in self._xmlcon dictionary</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">root</span><span class="p">,</span><span class="n">tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmlcon</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath_xml</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmlcon</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Instrument/Name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_xmlcon</span><span class="p">[</span><span class="s1">&#39;Sampling Interval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Instrument/SampleIntervalSeconds&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    

    <span class="k">def</span> <span class="nf">__parse_hex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Extracts information from SBE16/19 hex files such as hexadecimal strings (stored in self._hex_samples)</span>
<span class="sd">        and number of samples.</span>
<span class="sd">        </span>
<span class="sd">        Constructs timestamps for each sample and stores them in self.data[&#39;DateTime&#39;]</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="n">hex_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath_hex</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">hex_data</span> <span class="o">=</span> <span class="n">hex_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">hex_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span> <span class="o">=</span> <span class="n">hex_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*END*&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span>
        
        <span class="n">hex_header</span> <span class="o">=</span> <span class="n">hex_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*END*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        

        <span class="n">time_start</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c1"># Array to store start times for each sampling period in the file </span>
        <span class="n">number_samples</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># Array to store number of samples for each sampling period in the file</span>
  
        
        <span class="n">found</span><span class="o">=</span> <span class="kc">False</span> <span class="c1"># indicator if the * hdr was found (for method 1)</span>

        <span class="c1">## method 1 (works for IP instruments)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">hex_header</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;* hdr&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;* cast&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">time_start</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;samples&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">21</span><span class="p">:]))</span>
                <span class="n">sample_range</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;samples&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;to&#39;</span><span class="p">)]</span>
                <span class="n">n_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sample_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">number_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
                
                <span class="n">sampling_freq</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">.1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_xmlcon</span><span class="p">[</span><span class="s1">&#39;Sampling Interval&#39;</span><span class="p">]))</span>
                <span class="c1">#print(sampling_freq)</span>
                <span class="n">timestep</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">sampling_freq</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;seconds&#39;</span><span class="p">)</span>
                
                
                <span class="k">if</span> <span class="s1">&#39;int&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">timestep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;int = &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">timestep</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">timestep</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;seconds&#39;</span><span class="p">)</span>
                    
                    
                <span class="n">date_time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">time_start</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">periods</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">timestep</span><span class="p">)</span> <span class="c1"># Create empty DatetimeIndex </span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time_start</span><span class="p">)):</span>
                    <span class="n">daterange</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">time_start</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">periods</span><span class="o">=</span><span class="n">number_samples</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="n">timestep</span><span class="p">)</span>
                    <span class="n">date_time</span> <span class="o">=</span> <span class="n">date_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">daterange</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">number_samples</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_time</span>
                    
  
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="c1">#method 2 (works for HG instruments)</span>
            <span class="c1">#Procedure for parsing DeckSamplingSBE hex headers</span>

            <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span><span class="p">)</span> 

            <span class="n">hex_header</span> <span class="o">=</span> <span class="n">hex_data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*END*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">time_start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;* System UTC = &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">time_step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;* Real-Time Sample Interval = &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;seconds&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">time_step</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">time_step</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;seconds&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="o">=</span> <span class="n">n_samples</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">time_start</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">time_step</span><span class="p">)</span>
        
          
        
        
    <span class="k">def</span> <span class="nf">__get_xml_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Retrieves calibration coefficients for sensors detected in xml configuration file (.xmlcon) and</span>
<span class="sd">        stores them in self._coefficients_xml.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Dictionary of all possible sensors (as they appear in xml) and their calibration coefficients (the ones you want).</span>
        <span class="n">sensor_coefficients</span> <span class="o">=</span> \
        <span class="p">{</span>
        <span class="s1">&#39;TemperatureSensor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;A0&#39;</span><span class="p">,</span><span class="s1">&#39;A1&#39;</span><span class="p">,</span><span class="s1">&#39;A2&#39;</span><span class="p">,</span><span class="s1">&#39;A3&#39;</span><span class="p">],</span>
        <span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;G&#39;</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;J&#39;</span><span class="p">,</span><span class="s1">&#39;CPcor&#39;</span><span class="p">,</span><span class="s1">&#39;CTcor&#39;</span><span class="p">],</span>
        <span class="s1">&#39;PressureSensor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;PA0&#39;</span><span class="p">,</span><span class="s1">&#39;PA1&#39;</span><span class="p">,</span><span class="s1">&#39;PA2&#39;</span><span class="p">,</span><span class="s1">&#39;PTEMPA0&#39;</span><span class="p">,</span><span class="s1">&#39;PTEMPA1&#39;</span><span class="p">,</span><span class="s1">&#39;PTEMPA2&#39;</span><span class="p">,</span><span class="s1">&#39;PTCA0&#39;</span><span class="p">,</span><span class="s1">&#39;PTCA1&#39;</span><span class="p">,</span><span class="s1">&#39;PTCA2&#39;</span><span class="p">,</span><span class="s1">&#39;PTCB0&#39;</span><span class="p">,</span><span class="s1">&#39;PTCB1&#39;</span><span class="p">,</span><span class="s1">&#39;PTCB2&#39;</span><span class="p">],</span>
        <span class="s1">&#39;WET_LabsCStar&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;M&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;PathLength&#39;</span><span class="p">],</span>
        <span class="s1">&#39;OxygenSensor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;D0&#39;</span><span class="p">,</span><span class="s1">&#39;D1&#39;</span><span class="p">,</span><span class="s1">&#39;D2&#39;</span><span class="p">,</span><span class="s1">&#39;E&#39;</span><span class="p">,</span><span class="s1">&#39;Tau20&#39;</span><span class="p">,</span><span class="s1">&#39;H1&#39;</span><span class="p">,</span><span class="s1">&#39;H2&#39;</span><span class="p">,</span><span class="s1">&#39;H3&#39;</span><span class="p">,</span><span class="s1">&#39;Soc&#39;</span><span class="p">,</span><span class="s1">&#39;offset&#39;</span><span class="p">],</span>
        <span class="s1">&#39;TurbidityMeter&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;ScaleFactor&#39;</span><span class="p">,</span><span class="s1">&#39;DarkVoltage&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath_xml</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="k">for</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sensors</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="n">sensor</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">if</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">:</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Instrument/SensorArray/Sensor/ConductivitySensor/Coefficients&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="k">elif</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s1">&#39;OxygenSensor&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlcon</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SBE 19plus V2 Seacat CTD&#39;</span><span class="p">:</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;Instrument/SensorArray/Sensor/OxygenSensor/CalibrationCoefficients&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                
            <span class="k">elif</span> <span class="n">sensor</span> <span class="o">==</span> <span class="s1">&#39;OxygenSensor&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlcon</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SBE 16plus V2 Seacat CTD&#39;</span><span class="p">:</span>
                <span class="c1"># Overwrite OxygenSensor coefficients if SBE16 (uses different DO sensor and calibration)</span>
                <span class="n">sensor_coefficients</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;A0&#39;</span><span class="p">,</span><span class="s1">&#39;A1&#39;</span><span class="p">,</span><span class="s1">&#39;A2&#39;</span><span class="p">,</span><span class="s1">&#39;B0&#39;</span><span class="p">,</span><span class="s1">&#39;B1&#39;</span><span class="p">,</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="s1">&#39;pcor&#39;</span><span class="p">]</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Instrument/SensorArray/Sensor/OxygenSensor&#39;</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Instrument/SensorArray/Sensor/</span><span class="si">{</span><span class="n">sensor</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">coefficient</span> <span class="ow">in</span> <span class="n">sensor_coefficients</span><span class="p">[</span><span class="n">sensor</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="n">sensor</span><span class="p">][</span><span class="n">coefficient</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">coefficient</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__get_hex_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Retrieves calibration coefficients from SBE16/19 hex file (.hex) and stores them in self._coefficients_hex.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">hex_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath_hex</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">hex_header</span> <span class="o">=</span> <span class="n">hex_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">hex_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">hex_header</span> <span class="o">=</span> <span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*END*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span> <span class="o">=</span> <span class="p">{</span>
                                 <span class="s1">&#39;TemperatureSensor&#39;</span><span class="p">:</span> <span class="p">{},</span>
                                 <span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">:</span> <span class="p">{},</span>
                                 <span class="s1">&#39;PressureSensor&#39;</span><span class="p">:</span> <span class="p">{}</span>
                                <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;TemperatureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;TA0&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/TA0&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;TemperatureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;TA1&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/TA1&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;TemperatureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;TA2&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/TA2&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;TemperatureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A3&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;TA3&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/TA3&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;G&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/G&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;H&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;H&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/H&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;I&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/I&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;J&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;J&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/J&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;CPcor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;CPCOR&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/CPCOR&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;CTcor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;CTCOR&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/CTCOR&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PA0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PA0&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PA0&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PA1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PA1&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PA1&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PA2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PA2&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PA2&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTEMPA0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PTEMPA0&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PTEMPA0&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTEMPA1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PTEMPA1&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PTEMPA1&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTEMPA2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PTEMPA2&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PTEMPA2&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCA0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PTCA0&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PTCA0&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCA1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PTCA1&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PTCA1&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCA2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PTCA2&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PTCA2&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCB0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PTCB0&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PTCB0&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCB1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PTCB1&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PTCB1&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCB2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hex_header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;PTCB2&gt;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&lt;/PTCB2&gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        
        
    <span class="k">def</span> <span class="nf">__compare_coefficients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Compares calibration coefficients extracted from xml and hex file and warns user if they do not match.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">sensor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">coefficient</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="n">sensor</span><span class="p">]:</span>
                <span class="n">rtol</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="n">sensor</span><span class="p">][</span><span class="n">coefficient</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="n">sensor</span><span class="p">][</span><span class="n">coefficient</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_hex</span><span class="p">[</span><span class="n">sensor</span><span class="p">][</span><span class="n">coefficient</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">):</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;*** WARNING *** : </span><span class="si">{</span><span class="n">sensor</span><span class="si">}</span><span class="s1"> calibration coefficient </span><span class="si">{</span><span class="n">coefficient</span><span class="si">}</span><span class="s1"> in xmlcon does not match corresponding value in hex file... Proceeding with value from xmlcon.&#39;</span><span class="p">)</span>

    
    <span class="k">def</span> <span class="nf">__get_hex_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Extracts hexadecimal measurements from SBE16/19 hex file. </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">file_hex</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath_hex</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">data_hex</span> <span class="o">=</span> <span class="n">file_hex</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">file_hex</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span> <span class="o">=</span> <span class="n">data_hex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;*END*&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">__parse_hexstr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        parse the hexadecimal string x from index start to end. assume it is </span>
<span class="sd">        base 16 integer</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : string</span>
<span class="sd">            hex input string.</span>
<span class="sd">        start : int</span>
<span class="sd">            first character to parse</span>
<span class="sd">        end : int</span>
<span class="sd">            last_character to parse.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        out : TYPE</span>
<span class="sd">            DESCRIPTION.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">out</span> 
    
    
    <span class="k">def</span> <span class="nf">__hex2temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Calculates temperature (degrees Celcius, C) from hexadecimal string.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">A0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;TemperatureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span>
        <span class="n">A1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;TemperatureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span>
        <span class="n">A2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;TemperatureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span>
        <span class="n">A3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;TemperatureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A3&#39;</span><span class="p">]</span>
        
        <span class="n">temperature_decimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span><span class="p">])</span>
        <span class="n">MV</span> <span class="o">=</span> <span class="p">(</span><span class="n">temperature_decimal</span> <span class="o">-</span> <span class="mi">524288</span><span class="p">)</span><span class="o">/</span><span class="mf">1.6e7</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">((</span><span class="n">MV</span><span class="o">*</span><span class="mf">2.900e9</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.024e8</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.048e4</span> <span class="o">-</span> <span class="p">(</span><span class="n">MV</span><span class="o">*</span><span class="mf">2.0e5</span><span class="p">))</span>
        <span class="n">temperature_degrees</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">A0</span> <span class="o">+</span> <span class="n">A1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">+</span> <span class="n">A2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">A3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature (C)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperature_degrees</span>

    <span class="k">def</span> <span class="nf">__hex2time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">time_decimal</span>
        <span class="n">time_decimal1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__parse_hexstr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span><span class="p">])</span>
        
        <span class="c1">#time_decimal = np.array([int(x[42:50],base = 16) for x in self._hex_samples])</span>
        <span class="c1">#print(time_decimal, time_decimal1)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;01 Jan 2000&#39;</span><span class="p">)</span>  <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="s1">&#39;second&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">time_decimal</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>
        
    <span class="k">def</span> <span class="nf">__hex2conductivity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Calculates conductivity (Simiens/meter, S/m) from hexadecimal string.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;G&#39;</span><span class="p">]</span>
        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;H&#39;</span><span class="p">]</span>
        <span class="n">I</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;I&#39;</span><span class="p">]</span>
        <span class="n">J</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;J&#39;</span><span class="p">]</span>
        <span class="n">CPcor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;CPcor&#39;</span><span class="p">]</span>
        <span class="n">CTcor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;ConductivitySensor&#39;</span><span class="p">][</span><span class="s1">&#39;CTcor&#39;</span><span class="p">]</span>

        <span class="n">conductivity_decimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">12</span><span class="p">],</span> <span class="n">base</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span><span class="p">])</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">conductivity_decimal</span> <span class="o">/</span> <span class="mi">256</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="n">conductivity_spm</span> <span class="o">=</span> <span class="p">(</span><span class="n">G</span> <span class="o">+</span> <span class="n">H</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span> <span class="n">I</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">J</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">CTcor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature (C)&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">CPcor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Pressure (dbar)&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Conductivity (S/m)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conductivity_spm</span>


    <span class="k">def</span> <span class="nf">__hex2pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Calculates pressure (decibars, dbar) from hexadecimal string.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">PA0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PA0&#39;</span><span class="p">]</span>
        <span class="n">PA1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PA1&#39;</span><span class="p">]</span>
        <span class="n">PA2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PA2&#39;</span><span class="p">]</span>
        <span class="n">PTEMPA0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTEMPA0&#39;</span><span class="p">]</span>
        <span class="n">PTEMPA1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTEMPA1&#39;</span><span class="p">]</span>
        <span class="n">PTEMPA2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTEMPA2&#39;</span><span class="p">]</span>
        <span class="n">PTCA0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCA0&#39;</span><span class="p">]</span>
        <span class="n">PTCA1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCA1&#39;</span><span class="p">]</span>
        <span class="n">PTCA2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCA2&#39;</span><span class="p">]</span>
        <span class="n">PTCB0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCB0&#39;</span><span class="p">]</span>
        <span class="n">PTCB1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCB1&#39;</span><span class="p">]</span>
        <span class="n">PTCB2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;PressureSensor&#39;</span><span class="p">][</span><span class="s1">&#39;PTCB2&#39;</span><span class="p">]</span>
        

    

        <span class="n">pressure_decimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__parse_hexstr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span><span class="p">])</span>
        <span class="n">ptcv_decimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__parse_hexstr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">18</span><span class="p">,</span><span class="mi">22</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span><span class="p">])</span>
        
        <span class="n">y</span> <span class="o">=</span> <span class="n">ptcv_decimal</span> <span class="o">/</span> <span class="mi">13107</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">PTEMPA0</span> <span class="o">+</span> <span class="n">PTEMPA1</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="n">PTEMPA2</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">pressure_decimal</span> <span class="o">-</span> <span class="n">PTCA0</span> <span class="o">-</span> <span class="n">PTCA1</span><span class="o">*</span><span class="n">t</span> <span class="o">-</span> <span class="n">PTCA2</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">PTCB0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">PTCB0</span> <span class="o">+</span> <span class="n">PTCB1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">PTCB2</span><span class="o">*</span><span class="p">(</span><span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">pressure_dbar</span> <span class="o">=</span> <span class="n">PA0</span> <span class="o">+</span> <span class="n">PA1</span><span class="o">*</span><span class="n">n</span> <span class="o">+</span> <span class="n">PA2</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pressure_dbar</span> <span class="o">=</span> <span class="p">(</span><span class="n">pressure_dbar</span> <span class="o">-</span> <span class="mf">14.7</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.689476</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Pressure (dbar)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pressure_dbar</span>


    <span class="k">def</span> <span class="nf">__hex2turbidity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Calculates turbidity (Nephelometric turbidity, NTU) from hexadecimal string measured </span>
<span class="sd">        by WET Labs ECO NTU turbidity sensor.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">scale_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;TurbidityMeter&#39;</span><span class="p">][</span><span class="s1">&#39;ScaleFactor&#39;</span><span class="p">]</span>
        <span class="n">dark_voltage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;TurbidityMeter&#39;</span><span class="p">][</span><span class="s1">&#39;DarkVoltage&#39;</span><span class="p">]</span>
        <span class="c1">#print(self._xmlcon[&#39;Name&#39;], self._sensor_index[&#39;TurbidityMeter&#39;])</span>
        
        
        <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sensor_index</span><span class="p">[</span><span class="s1">&#39;TurbidityMeter&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">22</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="c1">#print(start_idx, end_idx)</span>
        
        <span class="n">turbidity_decimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__parse_hexstr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">start_idx</span><span class="p">,</span><span class="n">end_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span><span class="p">])</span>
        <span class="c1"># if self._xmlcon[&#39;Name&#39;] == &#39;SBE 16plus V2 Seacat CTD&#39;:</span>
            
        <span class="c1">#     turbidity_decimal = np.array([self.__parse_hexstr(x,26,30) for x in self._hex_samples])#np.array([int(x[26:30], base=16) for x in self._hex_samples])</span>
            
        <span class="c1"># elif self._xmlcon[&#39;Name&#39;] == &#39;SBE 19plus V2 Seacat CTD&#39;:</span>
            
        <span class="c1">#     turbidity_decimal = np.array([self.__parse_hexstr(x,30,34) for x in self._hex_samples])#np.array([int(x[30:34], base=16) for x in self._hex_samples])</span>
        
        <span class="n">turbidity_volt</span> <span class="o">=</span> <span class="n">turbidity_decimal</span> <span class="o">/</span> <span class="mi">13107</span>
        <span class="n">turbidity_ntu</span> <span class="o">=</span> <span class="n">scale_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">turbidity_volt</span> <span class="o">-</span> <span class="n">dark_voltage</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Turbidity (NTU)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">turbidity_ntu</span>
        
        
    <span class="k">def</span> <span class="nf">__hex2transmission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Calculates light transmission (%) and beam attenuation coefficients from hexadecimal string measured </span>
<span class="sd">        by WET Labs C-Star transmissometer.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;WET_LabsCStar&#39;</span><span class="p">][</span><span class="s1">&#39;M&#39;</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;WET_LabsCStar&#39;</span><span class="p">][</span><span class="s1">&#39;B&#39;</span><span class="p">]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;WET_LabsCStar&#39;</span><span class="p">][</span><span class="s1">&#39;PathLength&#39;</span><span class="p">]</span>
        
        <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sensor_index</span><span class="p">[</span><span class="s1">&#39;WET_LabsCStar&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">22</span>
        <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="c1">#print(start_idx, end_idx)</span>
        
        <span class="n">transmission_decimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__parse_hexstr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">start_idx</span><span class="p">,</span><span class="n">end_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span><span class="p">])</span>
        <span class="c1">#transmission_decimal = np.array([self.__parse_hexstr(x,22,26) for x in self._hex_samples])#np.array([int(x[22:26], base=16) for x in self._hex_samples])</span>
        <span class="n">transmission_volt</span> <span class="o">=</span> <span class="n">transmission_decimal</span> <span class="o">/</span> <span class="mi">13107</span>
        
        <span class="n">beam_transmission</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="o">*</span><span class="n">transmission_volt</span><span class="p">)</span> <span class="o">+</span> <span class="n">B</span>
        <span class="n">beam_attenuation</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">z</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">beam_transmission</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Light Transmission (%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam_transmission</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Beam Attenuation Coefficient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam_attenuation</span>
    
    
    <span class="k">def</span> <span class="nf">__hex2oxygen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Calculates oxygen concentration (milliliters/Liter, mL/L) from hexadecimal string.</span>
<span class="sd">        For details on calculation of salinity correction factor (Scorr) see Appendix I of:</span>
<span class="sd">        https://www.seabird.com/asset-get.download.jsa?id=54627862513</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sensor_index</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">22</span>
        <span class="c1">#end_idx = start_idx + 4</span>
        <span class="c1">#print(start_idx, end_idx)</span>
        <span class="c1"># SBE 63 Dissolved Oxygen Sensor calculations</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlcon</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SBE 16plus V2 Seacat CTD&#39;</span><span class="p">:</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">6</span>
            <span class="n">A0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span>
            <span class="n">A1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A1&#39;</span><span class="p">]</span>
            <span class="n">A2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A2&#39;</span><span class="p">]</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;B0&#39;</span><span class="p">]</span>
            <span class="n">B1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;B1&#39;</span><span class="p">]</span>
            <span class="n">C0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;C0&#39;</span><span class="p">]</span>
            <span class="n">C1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;C1&#39;</span><span class="p">]</span>
            <span class="n">C2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;C2&#39;</span><span class="p">]</span>
            <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;pcor&#39;</span><span class="p">]</span>
            
            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature (C)&#39;</span><span class="p">]</span>
            <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Pressure (dbar)&#39;</span><span class="p">]</span>
            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Salinity (PSU)&#39;</span><span class="p">]</span>  
            
            <span class="c1"># Coefficients for salinity correction factor (Scorr)</span>
            <span class="n">solB0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.24523e-3</span><span class="p">;</span> <span class="n">solB1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">7.37614e-3</span><span class="p">;</span> <span class="n">solB2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.03410e-2</span><span class="p">;</span> <span class="n">solB3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">8.17083e-3</span>
            <span class="n">solC0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.88682e-7</span>
            
            <span class="n">Ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mf">298.15</span><span class="o">-</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">273.15</span><span class="o">+</span><span class="n">T</span><span class="p">))</span>
            
            <span class="n">Scorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="p">(</span><span class="n">solB0</span><span class="o">+</span><span class="p">(</span><span class="n">solB1</span><span class="o">*</span><span class="n">Ts</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">solB2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="n">solB3</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span> <span class="o">+</span> <span class="p">(</span><span class="n">solC0</span><span class="o">*</span><span class="p">(</span><span class="n">S</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
            
            

            <span class="n">oxygen_decimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__parse_hexstr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">start_idx</span><span class="p">,</span><span class="n">end_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span><span class="p">])</span><span class="c1">#np.array([int(x[30:36], base=16) for x in self._hex_samples])</span>
            
            
            <span class="c1">#oxygen_decimal = np.array([self.__parse_hexstr(x,30,36) for x in self._hex_samples])#np.array([int(x[30:36], base=16) for x in self._hex_samples])</span>
            
            <span class="n">V</span> <span class="o">=</span> <span class="p">((</span><span class="n">oxygen_decimal</span><span class="o">/</span><span class="mi">100000</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mf">39.457071</span> 

            <span class="n">eqpt1</span> <span class="o">=</span> <span class="p">((</span><span class="n">A0</span><span class="o">+</span><span class="p">(</span><span class="n">A1</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">A2</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">B0</span><span class="o">+</span><span class="p">(</span><span class="n">B1</span><span class="o">*</span><span class="n">V</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">eqpt2</span> <span class="o">=</span> <span class="n">C0</span><span class="o">+</span><span class="p">(</span><span class="n">C1</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">eqpt3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">E</span><span class="o">*</span><span class="n">P</span><span class="o">/</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mf">273.15</span><span class="p">))</span>
            
            <span class="n">oxygen_conc</span> <span class="o">=</span> <span class="p">(</span><span class="n">eqpt1</span><span class="o">/</span><span class="n">eqpt2</span><span class="p">)</span><span class="o">*</span><span class="n">eqpt3</span><span class="o">*</span><span class="n">Scorr</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Oxygen (ml/l)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oxygen_conc</span>
        
        <span class="c1"># SBE 43 Dissolved Oxygen Sensor calculations</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xmlcon</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SBE 19plus V2 Seacat CTD&#39;</span><span class="p">:</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
            <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;B&#39;</span><span class="p">]</span>
            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
            <span class="c1">#D0 = self._coefficients_xml[&#39;OxygenSensor&#39;][&#39;D0&#39;]</span>
            <span class="c1">#D1 = self._coefficients_xml[&#39;OxygenSensor&#39;][&#39;D1&#39;]</span>
            <span class="c1">#D2 = self._coefficients_xml[&#39;OxygenSensor&#39;][&#39;D2&#39;]</span>
            <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">]</span>
            <span class="c1">#Tau20 = self._coefficients_xml[&#39;OxygenSensor&#39;][&#39;Tau20&#39;]</span>
            <span class="c1">#H1 = self._coefficients_xml[&#39;OxygenSensor&#39;][&#39;H1&#39;]</span>
            <span class="c1">#H2 = self._coefficients_xml[&#39;OxygenSensor&#39;][&#39;H2&#39;]</span>
            <span class="c1">#H3 = self._coefficients_xml[&#39;OxygenSensor&#39;][&#39;H3&#39;]</span>
            <span class="n">Soc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;Soc&#39;</span><span class="p">]</span>
            <span class="n">Voffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coefficients_xml</span><span class="p">[</span><span class="s1">&#39;OxygenSensor&#39;</span><span class="p">][</span><span class="s1">&#39;offset&#39;</span><span class="p">]</span>
            
            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature (C)&#39;</span><span class="p">]</span>
            <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Pressure (dbar)&#39;</span><span class="p">]</span>
            
            
            <span class="n">oxygen_decimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__parse_hexstr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">start_idx</span><span class="p">,</span><span class="n">end_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hex_samples</span><span class="p">])</span>
            <span class="c1">#oxygen_decimal = np.array([self.__parse_hexstr(x,26,30) for x in self._hex_samples])#np.array([int(x[26:30], base=16) for x in self._hex_samples])</span>
            
            <span class="n">V</span> <span class="o">=</span> <span class="n">oxygen_decimal</span> <span class="o">/</span> <span class="mi">13107</span>
            
            <span class="n">eqpt1</span> <span class="o">=</span> <span class="n">Soc</span><span class="o">*</span><span class="p">(</span><span class="n">V</span><span class="o">+</span><span class="n">Voffset</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">B</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span>
            <span class="n">eqpt2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">E</span><span class="o">*</span><span class="n">P</span><span class="o">/</span><span class="p">(</span><span class="n">T</span><span class="o">+</span><span class="mf">273.15</span><span class="p">))</span>
            <span class="n">oxysat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__oxygen_saturation</span><span class="p">()</span>
            
            <span class="n">oxygen_conc</span> <span class="o">=</span> <span class="n">eqpt1</span><span class="o">*</span><span class="n">eqpt2</span><span class="o">*</span><span class="n">oxysat</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Oxygen (ml/l)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oxygen_conc</span>
    
    
    <span class="k">def</span> <span class="nf">__conductivity2salinity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Calculates salinity (PSU) from conductivity following the standards of the Practical Salinity Scale - 1978 (PSS-78)</span>
<span class="sd">        For details on calculation see:</span>
<span class="sd">        https://salinometry.com/pss-78/</span>
<span class="sd">        https://www.seabird.com/asset-get.download.jsa?id=54627861526</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.008</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1692</span><span class="p">,</span> <span class="mf">25.3851</span><span class="p">,</span> <span class="mf">14.0941</span><span class="p">,</span> <span class="o">-</span><span class="mf">7.0261</span><span class="p">,</span> <span class="mf">2.7081</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0005</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0056</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0066</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0375</span><span class="p">,</span> <span class="mf">0.0636</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0144</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mf">0.0162</span>
        
        <span class="n">A1</span> <span class="o">=</span> <span class="mf">2.07e-5</span><span class="p">;</span> <span class="n">A2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.37e-10</span><span class="p">;</span> <span class="n">A3</span> <span class="o">=</span> <span class="mf">3.989e-15</span>
        <span class="n">B1</span> <span class="o">=</span> <span class="mf">3.426e-2</span><span class="p">;</span> <span class="n">B2</span> <span class="o">=</span> <span class="mf">4.464e-4</span><span class="p">;</span> <span class="n">B3</span> <span class="o">=</span> <span class="mf">4.215e-1</span><span class="p">;</span> <span class="n">B4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.107e-3</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="mf">6.766097e-1</span><span class="p">;</span> <span class="n">C1</span> <span class="o">=</span> <span class="mf">2.00564e-2</span><span class="p">;</span> <span class="n">C2</span> <span class="o">=</span> <span class="mf">1.104259e-4</span><span class="p">;</span> <span class="n">C3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.9698e-7</span><span class="p">;</span> <span class="n">C4</span> <span class="o">=</span> <span class="mf">1.0031e-9</span>
        
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature (C)&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.00024</span>      <span class="c1"># Temperature IPTS-68, C</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Pressure (dbar)&#39;</span><span class="p">]</span>                <span class="c1"># Pressure, dbars</span>
        <span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Conductivity (S/m)&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">4.2914</span>    <span class="c1"># Conductivity ratio (C of water at 35 PSU and 15C @ sea-level = 4.2914 S/m)</span>
        
        <span class="n">Rp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(((</span><span class="n">A1</span><span class="o">*</span><span class="n">P</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">A2</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="n">A3</span><span class="o">*</span><span class="p">(</span><span class="n">P</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">B1</span><span class="o">*</span><span class="n">T</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">B2</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="n">B3</span><span class="o">*</span><span class="n">R</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">B4</span><span class="o">*</span><span class="n">T</span><span class="o">*</span><span class="n">R</span><span class="p">)))</span>
        <span class="n">rT</span> <span class="o">=</span> <span class="n">C0</span> <span class="o">+</span> <span class="p">(</span><span class="n">C1</span><span class="o">*</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">C3</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">C4</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">RT</span> <span class="o">=</span> <span class="n">R</span><span class="o">/</span><span class="p">(</span><span class="n">Rp</span><span class="o">*</span><span class="n">rT</span><span class="p">)</span>
        
        <span class="n">S1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">S2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">S1</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">RT</span><span class="p">,(</span><span class="n">i</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">S2</span> <span class="o">+=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">RT</span><span class="p">,(</span><span class="n">i</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">S</span> <span class="o">=</span> <span class="n">S1</span> <span class="o">+</span> <span class="p">(((</span><span class="n">T</span><span class="o">-</span><span class="mi">15</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="mi">15</span><span class="p">))))</span><span class="o">*</span><span class="n">S2</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Salinity (PSU)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span>
       
        
    <span class="k">def</span> <span class="nf">__oxygen_saturation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Calculates the oxygen saturation limit (mL/L) as a function of temperature and salinity </span>
<span class="sd">        For details see Appendix A of:</span>
<span class="sd">        http://www.argodatamgt.org/content/download/26535/181243/file/SBE43_ApplicationNote64_RevJun2013.pdf</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            oxysat (np.array): oxygen saturation limit (mL/L)</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">A0</span> <span class="o">=</span> <span class="mf">2.00907</span><span class="p">;</span> <span class="n">A1</span> <span class="o">=</span> <span class="mf">3.22014</span><span class="p">;</span> <span class="n">A2</span> <span class="o">=</span> <span class="mf">4.0501</span><span class="p">;</span> <span class="n">A3</span> <span class="o">=</span> <span class="mf">4.94457</span><span class="p">;</span> <span class="n">A4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.256847</span><span class="p">;</span> <span class="n">A5</span> <span class="o">=</span> <span class="mf">3.88767</span>
        <span class="n">B0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.00624523</span><span class="p">;</span> <span class="n">B1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.00737614</span><span class="p">;</span> <span class="n">B2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.010341</span><span class="p">;</span> <span class="n">B3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.00817083</span>
        <span class="n">C0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.88682e-7</span>
        
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature (C)&#39;</span><span class="p">]</span>
        <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Salinity (PSU)&#39;</span><span class="p">]</span>
        
        <span class="n">Ts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mf">298.15</span><span class="o">-</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">273.15</span><span class="o">+</span><span class="n">T</span><span class="p">))</span>
        
        <span class="n">eqpt1</span> <span class="o">=</span> <span class="n">A0</span><span class="o">+</span><span class="p">(</span><span class="n">A1</span><span class="o">*</span><span class="n">Ts</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">A2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="n">A3</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="n">A4</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="o">**</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="n">A5</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="o">**</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">eqpt2</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span><span class="o">*</span><span class="p">(</span><span class="n">B0</span><span class="o">+</span><span class="p">(</span><span class="n">B1</span><span class="o">*</span><span class="n">Ts</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">B2</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="n">B3</span><span class="o">*</span><span class="p">(</span><span class="n">Ts</span><span class="o">**</span><span class="mi">3</span><span class="p">))))</span> <span class="o">+</span> <span class="p">(</span><span class="n">C0</span><span class="o">*</span><span class="p">(</span><span class="n">S</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="n">oxysat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">eqpt1</span><span class="o">+</span><span class="n">eqpt2</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">oxysat</span>
        
            

        
        
        <span class="k">return</span> <span class="n">df</span></div>

        
<span class="c1">#%%</span>




<span class="c1">#%%  </span>

<div class="viewcode-block" id="DataSet">
<a class="viewcode-back" href="../../../pyplume.ctd.html#pyplume.ctd.seabird_hex_decoder.DataSet">[docs]</a>
<span class="k">class</span> <span class="nc">DataSet</span><span class="p">(</span><span class="n">seabird_ctd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A derived class from seabird_ctd to enhance data handling and analytics specific </span>
<span class="sd">  to sea-bird conductivity, temperature, and depth (CTD) instruments.</span>

<span class="sd">  This class integrates additional functionalities for plotting, geometric calculations,</span>
<span class="sd">  data processing, and masking operations on top of the base functionalities provided</span>
<span class="sd">  by the seabird_ctd class.</span>

<span class="sd">  Attributes:</span>
<span class="sd">      plot (__Plotting): An instance of the nested __Plotting class for handling data visualization.</span>
<span class="sd">      name (str): The filename extracted from the filepath_hex, used as an identifier.</span>
<span class="sd">      geometry (__Geometry): An instance of the nested __Geometry class for managing sensor geometry.</span>
<span class="sd">      mask (__Masking): An instance of the nested __Masking class for applying masks to the data.</span>
<span class="sd">      processing (__Processing): An instance of the nested __Processing class for additional data processing tasks.</span>

<span class="sd">  Parameters:</span>
<span class="sd">      filepath_hex (str): Path to the hexadecimal data file from the CTD instrument.</span>
<span class="sd">      filepath_xml (str): Path to the XML configuration file associated with the CTD data.</span>
<span class="sd">      **kwargs: Arbitrary keyword arguments that can be passed to the seabird_ctd constructor.</span>

<span class="sd">  Methods:</span>
<span class="sd">      get_timeseries_data(field_name=&#39;Turbidity (NTU)&#39;, mask=True): Retrieves timeseries data for a specified field.</span>

<span class="sd">     &quot;&quot;&quot;</span>   
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filepath_hex</span><span class="p">,</span> <span class="n">filepath_xml</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath_hex</span><span class="p">,</span> <span class="n">filepath_xml</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Plotting</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">filepath_hex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Masking</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Processing</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timezone_correction</span> <span class="o">=</span> <span class="mi">0</span>

        
<div class="viewcode-block" id="DataSet.get_timeseries_data">
<a class="viewcode-back" href="../../../pyplume.ctd.html#pyplume.ctd.seabird_hex_decoder.DataSet.get_timeseries_data">[docs]</a>
    <span class="k">def</span> <span class="nf">get_timeseries_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;Turbidity (NTU)&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve timeseries data for a given field name.</span>
<span class="sd">    </span>
<span class="sd">        Parameters:</span>
<span class="sd">        - field_name (str): Name of the field for which timeseries data is retrieved (default: &#39;Turbidity (NTU)&#39;).</span>
<span class="sd">        - mask (bool): If True, any defined masks will be applied to the data (default: True).</span>
<span class="sd">    </span>
<span class="sd">        Returns:</span>
<span class="sd">        - t (numpy.ndarray): DateTime array representing the time values.</span>
<span class="sd">        - x (numpy.ndarray): Timeseries data array for the specified field_name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timezone_correction</span><span class="si">}</span><span class="s1">h&#39;</span><span class="p">)</span> <span class="c1">#apply timezone correction</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span> <span class="c1"># apply masks </span>
            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">apply_masks</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span></div>

    
<div class="viewcode-block" id="DataSet.to_csv">
<a class="viewcode-back" href="../../../pyplume.ctd.html#pyplume.ctd.seabird_hex_decoder.DataSet.to_csv">[docs]</a>
    <span class="k">def</span> <span class="nf">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_pandas_df</span><span class="p">()</span>
        
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timezone_correction</span><span class="si">}</span><span class="s1">h&#39;</span><span class="p">)</span> <span class="c1">#apply timezone correction</span>
        
        <span class="n">filename_hex</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filepath_hex</span><span class="p">)</span>
        <span class="n">filename_csv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename_hex</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span>
        
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">filename_csv</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="DataSet.to_pandas_df">
<a class="viewcode-back" href="../../../pyplume.ctd.html#pyplume.ctd.seabird_hex_decoder.DataSet.to_pandas_df">[docs]</a>
    <span class="k">def</span> <span class="nf">to_pandas_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timezone_correction</span><span class="si">}</span><span class="s1">h&#39;</span><span class="p">)</span> <span class="c1">#apply timezone correction</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;DateTime&#39;</span><span class="p">,</span><span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span><span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">df</span></div>

        
    <span class="k">class</span> <span class="nc">__Processing</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manage data processing functionality for CTD data.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ctd : CTD</span>
<span class="sd">            CTD (Conductivity, Temperature, Depth) object.</span>
<span class="sd">    </span>
<span class="sd">        Methods</span>
<span class="sd">        -------</span>
<span class="sd">        calculate_depth(environment=&#39;SALTWATER&#39;)</span>
<span class="sd">            Calculate depth from pressure following SBE APPLICATION NOTE NO. 69.</span>
<span class="sd">    </span>
<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        _ctd : CTD</span>
<span class="sd">            CTD object containing data for processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctd</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span> <span class="o">=</span> <span class="n">ctd</span>
            
            
        <span class="k">def</span> <span class="nf">calculate_SSC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculates Suspended Solids Concentration (SSC) from turbidity data.</span>
<span class="sd">        </span>
<span class="sd">            Parameters:</span>
<span class="sd">            - self (object): Instance of the class containing CTD data.</span>
<span class="sd">            - A (float): Conversion factor from Turbidity (NTU) to SSC.</span>
<span class="sd">        </span>
<span class="sd">            Returns:</span>
<span class="sd">            None. Updates the CTD data with the calculated SSC values.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># convert from turbidity (NTU) to suspended solids concentration assuming SSC = A * NTU</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;SSC (mg/L)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Turbidity (NTU)&#39;</span><span class="p">]</span>
            
    
        <span class="k">def</span> <span class="nf">calculate_depth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="o">=</span><span class="s1">&#39;SALTWATER&#39;</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate depth from pressure following SBE APPLICATION NOTE NO. 69.</span>
<span class="sd">    </span>
<span class="sd">            Sea-Bird uses the formula in UNESCO Technical Papers in Marine Science</span>
<span class="sd">            No. 44. This is an empirical formula that takes compressibility (that is,</span>
<span class="sd">            density) into account. An ocean water column at 0 C (t = 0) and 35 PSU</span>
<span class="sd">            (s = 35) is assumed.</span>
<span class="sd">            </span>
<span class="sd">            If latitude has not been calculated in the position</span>
<span class="sd">            dataset, then both latitude and longitude will be calculated </span>
<span class="sd">            automatically</span>
<span class="sd">    </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            environment : str, optional</span>
<span class="sd">                Specify whether the CTD is in &quot;SALTWATER&quot; or &quot;FRESHWATER&quot;.</span>
<span class="sd">                The default is &#39;SALTWATER&#39;.</span>
<span class="sd">    </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            

    
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Pressure (dbar)&#39;</span><span class="p">]</span> <span class="c1"># Pressure</span>
            <span class="n">latitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>  <span class="c1"># </span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">latitude</span> <span class="o">/</span> <span class="mf">57.29578</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="mf">9.780318</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">((</span><span class="mf">5.2788e-3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.36e-5</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.092e-6</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span>  <span class="c1"># Gravity variation with latitude and pressure</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">((((</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.82e-15</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span> <span class="o">+</span> <span class="mf">2.279e-10</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span> <span class="o">-</span> <span class="mf">2.2512e-5</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span> <span class="o">+</span> <span class="mf">9.72659</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="n">g</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>  <span class="c1"># Update the data dictionary</span>
                
            
        <span class="k">def</span> <span class="nf">calculate_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the density of seawater using UNESCO 1983 polynomial equations of state.</span>
<span class="sd">            </span>
<span class="sd">            Validated agaist this online calucator https://www.phys.ocean.dal.ca/~kelley/seawater/density.html</span>
<span class="sd">            Parameters:</span>
<span class="sd">            - s : numpy.ndarray</span>
<span class="sd">                Salinity in Practical Salinity Units (PSU).</span>
<span class="sd">            - t : numpy.ndarray</span>
<span class="sd">                Temperature in degrees Celsius.</span>
<span class="sd">            - p : numpy.ndarray</span>
<span class="sd">                Pressure in decibars.</span>
<span class="sd">            </span>
<span class="sd">            Returns:</span>
<span class="sd">            - numpy.ndarray</span>
<span class="sd">                Density of seawater.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Temperature (C)&#39;</span><span class="p">])</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Pressure (dbar)&#39;</span><span class="p">])</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Salinity (PSU)&#39;</span><span class="p">])</span>
            
            <span class="n">A0</span> <span class="o">=</span> <span class="mf">999.842594</span>
            <span class="n">A1</span> <span class="o">=</span> <span class="mf">6.793952e-2</span>
            <span class="n">A2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.095290e-3</span>
            <span class="n">A3</span> <span class="o">=</span> <span class="mf">1.001685e-4</span>
            <span class="n">A4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.120083e-6</span>
            <span class="n">A5</span> <span class="o">=</span> <span class="mf">6.536332e-9</span>
            
            <span class="n">B0</span> <span class="o">=</span> <span class="mf">8.24493e-1</span>
            <span class="n">B1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.0899e-3</span>
            <span class="n">B2</span> <span class="o">=</span> <span class="mf">7.6438e-5</span>
            <span class="n">B3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">8.2467e-7</span>
            <span class="n">B4</span> <span class="o">=</span> <span class="mf">5.3875e-9</span>
            
            <span class="n">C0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.72466e-3</span>
            <span class="n">C1</span> <span class="o">=</span> <span class="mf">1.0227e-4</span>
            <span class="n">C2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.6546e-6</span>
            
            <span class="n">D0</span> <span class="o">=</span> <span class="mf">4.8314e-4</span>
            
            
            
            <span class="n">FQ0</span> <span class="o">=</span> <span class="mf">54.6746</span>
            <span class="n">FQ1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.603459</span>
            <span class="n">FQ2</span> <span class="o">=</span> <span class="mf">1.09987e-2</span>
            <span class="n">FQ3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.1670e-5</span>
            
            <span class="n">G0</span> <span class="o">=</span> <span class="mf">7.944e-2</span>
            <span class="n">G1</span> <span class="o">=</span> <span class="mf">1.6483e-2</span>
            <span class="n">G2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.3009e-4</span>
            
            <span class="n">i0</span> <span class="o">=</span> <span class="mf">2.2838e-3</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0981e-5</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.6078e-6</span>
            
            <span class="n">J0</span> <span class="o">=</span> <span class="mf">1.91075e-4</span>
            
            <span class="n">M0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9.9348e-7</span>
            <span class="n">M1</span> <span class="o">=</span> <span class="mf">2.0816e-8</span>
            <span class="n">M2</span> <span class="o">=</span> <span class="mf">9.1697e-10</span>
            
            <span class="n">E0</span> <span class="o">=</span> <span class="mf">19652.21</span>
            <span class="n">E1</span> <span class="o">=</span> <span class="mf">148.4206</span> <span class="c1">#c</span>
            <span class="n">E2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.327105</span>
            <span class="n">E3</span> <span class="o">=</span> <span class="mf">1.360477e-2</span>
            <span class="n">E4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.155288e-5</span>
            
            <span class="n">H0</span> <span class="o">=</span> <span class="mf">3.239908</span>
            <span class="n">H1</span> <span class="o">=</span> <span class="mf">1.43713e-3</span>
            <span class="n">H2</span> <span class="o">=</span> <span class="mf">1.16092e-4</span>
            <span class="n">H3</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.77905e-7</span>
            
            <span class="n">K0</span> <span class="o">=</span> <span class="mf">8.50935e-5</span>
            <span class="n">K1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.12293e-6</span>
            <span class="n">K2</span> <span class="o">=</span> <span class="mf">5.2787e-8</span>
            
            <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t</span>
            <span class="n">t3</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t2</span>
            <span class="n">t4</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t3</span>
            <span class="n">t5</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">t4</span>
            
            <span class="c1">#s = np.maximum(s, 0.000001)  # Avoid division by zero</span>
            
            <span class="n">s32</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
            
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">/</span><span class="mf">10.0</span>  <span class="c1"># convert decibars to bars</span>
            
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">A0</span> <span class="o">+</span> <span class="n">A1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">A2</span><span class="o">*</span><span class="n">t2</span> <span class="o">+</span> <span class="n">A3</span><span class="o">*</span><span class="n">t3</span> <span class="o">+</span> <span class="n">A4</span><span class="o">*</span><span class="n">t4</span> <span class="o">+</span> <span class="n">A5</span><span class="o">*</span><span class="n">t5</span><span class="o">+</span> <span class="p">(</span><span class="n">B0</span> <span class="o">+</span> <span class="n">B1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">B2</span><span class="o">*</span><span class="n">t2</span> <span class="o">+</span> <span class="n">B3</span><span class="o">*</span><span class="n">t3</span> <span class="o">+</span> <span class="n">B4</span><span class="o">*</span><span class="n">t4</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">+</span> <span class="p">(</span><span class="n">C0</span> <span class="o">+</span> <span class="n">C1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">C2</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span><span class="o">*</span><span class="n">s32</span> <span class="o">+</span> <span class="n">D0</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">s</span>
            
            <span class="n">kw</span> <span class="o">=</span> <span class="n">E0</span> <span class="o">+</span> <span class="n">E1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">E2</span><span class="o">*</span><span class="n">t2</span> <span class="o">+</span> <span class="n">E3</span><span class="o">*</span><span class="n">t3</span> <span class="o">+</span> <span class="n">E4</span><span class="o">*</span><span class="n">t4</span>
            <span class="n">aw</span> <span class="o">=</span> <span class="n">H0</span> <span class="o">+</span> <span class="n">H1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">H2</span><span class="o">*</span><span class="n">t2</span> <span class="o">+</span> <span class="n">H3</span><span class="o">*</span><span class="n">t3</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="n">K0</span> <span class="o">+</span> <span class="n">K1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">K2</span><span class="o">*</span><span class="n">t2</span>
            
            <span class="n">k</span> <span class="o">=</span> <span class="n">kw</span> <span class="o">+</span> <span class="p">(</span><span class="n">FQ0</span> <span class="o">+</span> <span class="n">FQ1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">FQ2</span><span class="o">*</span><span class="n">t2</span> <span class="o">+</span> <span class="n">FQ3</span><span class="o">*</span><span class="n">t3</span><span class="p">)</span><span class="o">*</span><span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="n">G0</span> <span class="o">+</span> <span class="n">G1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">G2</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span><span class="o">*</span><span class="n">s32</span><span class="o">+</span> <span class="p">(</span><span class="n">aw</span> <span class="o">+</span> <span class="p">(</span><span class="n">i0</span> <span class="o">+</span> <span class="n">i1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">i2</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span><span class="o">*</span><span class="n">s</span> <span class="o">+</span> <span class="p">(</span><span class="n">J0</span><span class="o">*</span><span class="n">s32</span><span class="p">))</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="p">(</span><span class="n">bw</span> <span class="o">+</span> <span class="p">(</span><span class="n">M0</span> <span class="o">+</span> <span class="n">M1</span><span class="o">*</span><span class="n">t</span> <span class="o">+</span> <span class="n">M2</span><span class="o">*</span><span class="n">t2</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">p</span>
            
            <span class="n">val</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">k</span><span class="p">)</span>
            
            <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma</span><span class="o">/</span><span class="n">val</span><span class="p">)</span> <span class="c1">#- 1000</span>
                <span class="c1"># non_zero_mask = val != 0.0</span>
                <span class="c1"># sigma[non_zero_mask] = sigma[non_zero_mask] / val[non_zero_mask] - 1000.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Density (kg/m3)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma</span>


    <span class="k">class</span> <span class="nc">__Geometry</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manage the geometry (position, orientation, etc...) of an instrument.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ctd : CTD</span>
<span class="sd">            CTD (Conductivity, Temperature, Depth) object.</span>
<span class="sd">    </span>
<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        relative_position : numpy array</span>
<span class="sd">            Position of the sensor relative to the position measurement for the instrument.</span>
<span class="sd">        Pose : Pose</span>
<span class="sd">            Pose object containing the instrument&#39;s position and orientation at all timestamps.</span>
<span class="sd">    </span>
<span class="sd">        Methods</span>
<span class="sd">        -------</span>
<span class="sd">        set_Pose(Pose)</span>
<span class="sd">            Define the instrument pose (position and orientation) with a Pose object.</span>
<span class="sd">    </span>
<span class="sd">        set_sensor_relative_geometry(rotation=0, offset=(0, 0, 0))</span>
<span class="sd">            Calculate the x, y, z position of the sensor in the coordinate reference frame of the instrument.</span>
<span class="sd">    </span>
<span class="sd">        get_absolute_sensor_position()</span>
<span class="sd">            Calculate the absolute position of the sensor, taking into account the position and orientation of the platform.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctd</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span> <span class="o">=</span> <span class="n">ctd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relative_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="kc">None</span>
    
        <span class="k">def</span> <span class="nf">set_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Pose</span><span class="p">,</span> <span class="n">update_depth</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Define the instrument pose (position and orientation) with a </span>
<span class="sd">            Pose object. Makes a cope of the pose object and stores it under </span>
<span class="sd">            ctd.geometry.Pose</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            Pose : Pose</span>
<span class="sd">                Pose object containing position and orientation information.</span>
<span class="sd">            update_depth : bool, optional </span>
<span class="sd">                If True, the calculated depth (from ctd pressure) will be used</span>
<span class="sd">                as the pose z variable data. </span>
<span class="sd">    </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            
            
            
            
            <span class="c1"># copy input object and Resample the input timeseries to the CTD measurement timesteps.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Pose</span><span class="p">)</span>
            
            <span class="c1"># ## infer the best tolerance </span>
            <span class="c1"># t = self._ctd.data[&#39;DateTime&#39;].to_numpy()</span>
            <span class="c1"># dt = np.diff(t,prepend = t[0],).astype(float)/1e9 # time delta in seconds</span>
            <span class="c1"># tolerance = 1.01*np.percentile(dt,99) # mask to identify data gaps </span>
            <span class="c1"># print(tolerance)</span>
            
            
            <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">resample_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">],</span><span class="n">kwargs</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">add_lat_lon</span><span class="p">()</span>

            
            <span class="c1"># update pose z variable with calculated depth from ctd data</span>
            <span class="k">if</span> <span class="n">update_depth</span><span class="p">:</span>
                <span class="c1"># calculate latitude and longitude if needed</span>
                <span class="c1"># if not self.pose.pose.get(&#39;latitude&#39;):</span>
                <span class="c1">#     self._ctd.geometry.pose.add_lat_lon()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">add_lat_lon</span><span class="p">()</span>
                <span class="c1"># calculate depth (based on pressure and latitude)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">processing</span><span class="o">.</span><span class="n">calculate_depth</span><span class="p">()</span>
                
                <span class="c1"># resample input timeser</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">resample_from</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Depth (m)&#39;</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;DateTime&#39;</span><span class="p">]),</span><span class="n">field_name</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">z_convention</span> <span class="o">=</span> <span class="s1">&#39;reverse&#39;</span><span class="p">)</span>
                
                

                
            
            
    
        <span class="k">def</span> <span class="nf">set_sensor_relative_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the x, y, z position of the sensor in the coordinate reference frame of the instrument.</span>
<span class="sd">    </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            rotation : float, optional</span>
<span class="sd">                Rotation angle (in degrees) of the sensor.</span>
<span class="sd">                The default is 0.</span>
<span class="sd">    </span>
<span class="sd">            offset : numpy array, optional</span>
<span class="sd">                x, y, z offsets for the instrument. This offset should be the relative distance between the</span>
<span class="sd">                position measurement (e.g., from the vessel GPS) and the center of the sensor.</span>
<span class="sd">                The default is (0, 0, 0).</span>
<span class="sd">    </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relative_position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>  <span class="c1"># Position of the sensor relative to the instrument.</span>
    
        <span class="k">def</span> <span class="nf">get_absolute_sensor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the absolute position of the sensor, taking into account the position and orientation</span>
<span class="sd">            of the platform (e.g., ROV), and the relative position of the sensor on the platform.</span>
<span class="sd">    </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            absolute_position: numpy array</span>
<span class="sd">                numpy array containing the (x, y, z) position of the sensor for every timestep.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Get position of beam midpoints for every ensemble.</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">n_samples</span><span class="p">))</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">pose</span>
    
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">n_samples</span><span class="p">):</span>
                <span class="c1"># Build rotation matrix.</span>
                <span class="n">yaw</span> <span class="o">=</span> <span class="n">pose</span><span class="p">[</span><span class="s1">&#39;heading&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pitch</span> <span class="o">=</span> <span class="n">pose</span><span class="p">[</span><span class="s1">&#39;pitch&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">roll</span> <span class="o">=</span> <span class="n">pose</span><span class="p">[</span><span class="s1">&#39;roll&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ptools</span><span class="o">.</span><span class="n">gen_rot_x</span><span class="p">(</span><span class="n">roll</span><span class="p">),</span> <span class="n">ptools</span><span class="o">.</span><span class="n">gen_rot_z</span><span class="p">(</span><span class="n">yaw</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ptools</span><span class="o">.</span><span class="n">gen_rot_y</span><span class="p">(</span><span class="n">pitch</span><span class="p">)))</span>  <span class="c1"># 3-d rotation operator</span>
                <span class="n">Xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pose</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">relative_position</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">R</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Apply rotation to sensor relative orientation vector</span>
                <span class="n">X</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xp</span>  <span class="c1"># Update position for the current sample</span>
    
            <span class="c1"># Apply masks (for x, y, z coordinates).</span>
            <span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">apply_masks</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">apply_masks</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">apply_masks</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    
            <span class="k">return</span> <span class="n">X</span>
            
    
    <span class="k">class</span> <span class="nc">__Plotting</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manage plotting functionality for CTD data.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ctd : CTD</span>
<span class="sd">            CTD (Conductivity, Temperature, Depth) object.</span>
<span class="sd">    </span>
<span class="sd">        Methods</span>
<span class="sd">        -------</span>
<span class="sd">        timeseries(field_name=&#39;Turbidity (NTU)&#39;)</span>
<span class="sd">            Create a timeseries plot of CTD data.</span>
<span class="sd">    </span>
<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        _ctd : CTD</span>
<span class="sd">            CTD object containing data for plotting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctd</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span> <span class="o">=</span> <span class="n">ctd</span>
    
        <span class="k">def</span> <span class="nf">timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;Turbidity (NTU)&#39;</span><span class="p">,</span><span class="n">mask</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create a timeseries plot of CTD data.</span>
<span class="sd">    </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            field_name : str, optional</span>
<span class="sd">                Name of the field to plot. Any key in the CTD data dictionary or &#39;all&#39; to plot all fields in subplots.</span>
<span class="sd">                The default is &#39;Turbidity (NTU)&#39;. </span>
<span class="sd">            mask: bool, optional</span>
<span class="sd">                if True, masks will be applied to the data (default). If false, raw data will be plotted. </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            fig : matplotlib.figure.Figure</span>
<span class="sd">                Matplotlib figure object.</span>
<span class="sd">    </span>
<span class="sd">            ax : matplotlib.axes._axes.Axes</span>
<span class="sd">                Matplotlib axes object.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            
            <span class="c1">#if field_name == &#39;all&#39;:</span>
            
            
            
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">get_timeseries_data</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">,</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time&#39;</span><span class="p">)</span>
    
            <span class="n">xlims</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%H:%M </span><span class="si">%d</span><span class="s1">%b%y &#39;</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">tick_bottom</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
            
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">_filepath_hex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">_filepath_xml</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">7</span><span class="p">)</span>
    
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
                
            
    <span class="k">class</span> <span class="nc">__Masking</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manage masking functionality for CTD data.</span>
<span class="sd">    </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ctd : CTD</span>
<span class="sd">            CTD (Conductivity, Temperature, Depth) object.</span>
<span class="sd">    </span>
<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        _ctd : CTD</span>
<span class="sd">            CTD object containing data for masking.</span>
<span class="sd">        masks : dict</span>
<span class="sd">            Dictionary to hold masks for ensemble data.</span>
<span class="sd">        mask_status : dict</span>
<span class="sd">            Dictionary to hold activation status of defined masks.</span>
<span class="sd">    </span>
<span class="sd">        Methods</span>
<span class="sd">        -------</span>
<span class="sd">        define_mask(mask, name, set_active=False)</span>
<span class="sd">            Define a boolean mask that can be applied to timeseries data.</span>
<span class="sd">            </span>
<span class="sd">        set_mask_status(status, name=&#39;all&#39;)</span>
<span class="sd">            Change the status of a mask, or multiple masks.</span>
<span class="sd">            </span>
<span class="sd">        apply_masks(X)</span>
<span class="sd">            Apply all active masks to the ensemble array X.</span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctd</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span> <span class="o">=</span> <span class="n">ctd</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dictionary to hold masks for ensemble data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mask_status</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dictionary to hold activation status of defined masks</span>
    
        <span class="k">def</span> <span class="nf">define_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">set_active</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Define a boolean mask that can be applied to timeseries data.</span>
<span class="sd">    </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            mask : numpy array</span>
<span class="sd">                Numpy array with dimensions (n_samples).</span>
<span class="sd">            name : str</span>
<span class="sd">                Name for the mask.</span>
<span class="sd">            set_active : bool, optional</span>
<span class="sd">                If True, the defined mask will be activated.</span>
<span class="sd">                Default is False.</span>
<span class="sd">    </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Check that mask has correct dimensions</span>
            <span class="n">valid_dims</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ctd</span><span class="o">.</span><span class="n">n_samples</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">valid_dims</span><span class="p">:</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mask must have dimensions of </span><span class="si">{</span><span class="n">valid_dims</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
            <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
    
            <span class="c1"># Initialize the mask status</span>
            <span class="k">if</span> <span class="n">set_active</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mask_status</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mask_status</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
        <span class="k">def</span> <span class="nf">set_mask_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Change the status of a mask, or multiple masks.</span>
<span class="sd">            The ensemble data corresponding to FALSE entries in the mask will be converted to np.nan.</span>
<span class="sd">    </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            name : str or list of str, optional</span>
<span class="sd">                Mask name, or list of mask names. If &#39;all&#39;, all defined masks will be activated.</span>
<span class="sd">                The default is &#39;all&#39;.</span>
<span class="sd">            status : bool</span>
<span class="sd">                New status for the mask(s).</span>
<span class="sd">    </span>
<span class="sd">            Raises</span>
<span class="sd">            ------</span>
<span class="sd">            ValueError</span>
<span class="sd">                Invalid mask name.</span>
<span class="sd">    </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mask_status</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="c1"># Check if mask exists</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">mask_status</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1"> is not a defined mask.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mask_status</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> is not a defined mask.&#39;</span><span class="p">)</span>
    
        <span class="k">def</span> <span class="nf">apply_masks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Apply all of the active masks to the ensemble array X.</span>
<span class="sd">            Masked values will be converted to np.nan.</span>
<span class="sd">    </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            X : numpy array</span>
<span class="sd">                Array of ensemble data with dimensions (n_bins, n_ensembles).</span>
<span class="sd">    </span>
<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            X : numpy array</span>
<span class="sd">                Masked array of ensemble data with dimensions (n_bins, n_ensembles).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">mask_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_status</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]:</span>
                        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">putmask</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    
            <span class="k">return</span> <span class="n">X</span></div>

    

<span class="c1">#%%</span>


<span class="c1"># hex_fpath = r&#39;P:\41806287\41806287 NORI-D Data\Data\ROV\Hidden Gem\CTD\Raw\ROVDive20220921\DHIDive4_220921_1.hex&#39;</span>
<span class="c1"># xmlcon_fpath = r&#39;P:\41806287\41806287 NORI-D Data\Data\ROV\Hidden Gem\CTD\Raw\ROVDive20220921\DHIDIVE4_220921_1.xmlcon&#39;</span>
<span class="c1"># ctd1 = seabird_ctd(filepath_hex = hex_fpath, filepath_xml = xmlcon_fpath)</span>
<span class="c1"># print(ctd1._sensor_index)</span>

<span class="c1"># hex_fpath = r&#39;P:\41806287\41806287 NORI-D Data\Data\ROV\Island Pride\CTD\Raw\ROV_CTD_09102022\SBE19plus_01907947_2022_10_09_0005.hex&#39;</span>
<span class="c1"># xmlcon_fpath = r&#39;P:\41806287\41806287 NORI-D Data\Data\ROV\Island Pride\CTD\Config\SBE19-7947_DO-1900_CStar-1917_NTU-5874_xmiss_DO_swap.xmlcon&#39;</span>
<span class="c1"># ctd2 = seabird_ctd(filepath_hex = hex_fpath, filepath_xml = xmlcon_fpath)</span>
<span class="c1"># print(ctd2._sensor_index)</span>
<span class="c1">#ctd = DataSet(filepath_hex = hex_fpath, filepath_xml = xmlcon_fpath)</span>
<span class="c1">#%</span>
<span class="c1">#%%</span>
<span class="c1"># tree = ET.parse(ctd._filepath_xml)</span>
<span class="c1"># root = tree.getroot()</span>



<span class="c1"># sensors = {}</span>

<span class="c1"># for sensor in root.findall(&#39;Instrument/SensorArray/&#39;):</span>
<span class="c1">#     for s1 in sensor:</span>
<span class="c1">#         sensors[s1.tag] = {}</span>
        
        
<span class="c1">#         #sensors[&#39;Sen&#39;] = </span>
<span class="c1">#         #{&#39;SensorID&#39;: &#39;38&#39;}</span>
<span class="c1">#         print(s1.attrib)</span>
<span class="c1">#         for s2 in s1:</span>
<span class="c1">#             sensors[s1.tag][s2.tag] = {}</span>
<span class="c1">#             for s3 in s2:</span>
<span class="c1">#                 print(s1.tag,s2.tag,s3.tag)</span>
<span class="c1">#                 sensors[s1.tag][s2.tag][s3.tag] = s3.text #pd.to_numeric(s3.text)</span>
        
        
        <span class="c1"># print(sensor.attrib)</span>
        <span class="c1"># print(child)</span>

<span class="c1">#%% read the xmlcon to get sensor order </span>





<span class="c1">#%%</span>

<span class="c1"># xml_filepath = r&#39;\\USDEN1-STOR.DHI.DK\\Projects\\41806287\\41806287 NORI-D Data\\Data\\ROV\\Island Pride HD14\\CTD\\Raw\\ROV_CTD_07102022\\Configuration\\SBE19-7947_DO-1900_CStar-1917_NTU-5874_xmiss_DO_swap.xmlcon&#39;</span>
<span class="c1"># hex_filepath = r&#39;\\USDEN1-STOR.DHI.DK\\Projects\\41806287\\41806287 NORI-D Data\\Data\\ROV\\Island Pride HD14\\CTD\\Raw\\ROV_CTD_27102022\\SBE19plus_01907947_2022_10_27_0026.hex&#39;</span>
<span class="c1"># ctd = DataSet(hex_filepath,xml_filepath)</span>

<span class="c1"># x,t = ctd.get_timeseries_data()</span>

<span class="c1"># mask = (x&gt;0.2)</span>
<span class="c1"># ctd.mask.define_mask(mask = mask, name = &#39;turbidity&#39;,set_active = True)</span>


<span class="c1"># ctd.plot.timeseries_plot()</span>


<span class="c1"># def main():     </span>
    
<span class="c1">#     scriptpath = os.path.abspath(&#39;.&#39;)</span>
    
<span class="c1">#     relpath_xml = &#39;ROV CTD/Config/SBE19-7947_DO-1900_CStar-1917_NTU-5874_xmiss_DO_swap.xmlcon&#39;</span>
<span class="c1">#     #relpath_xml = &#39;FBCT1 CTD/Config/16-50406.xmlcon&#39;</span>
<span class="c1">#     #relpath_xml = &#39;DeckSamplingSBE/DECKSMPL_RETURN03.XMLCON&#39;</span>

<span class="c1">#     relpath_hex = &#39;ROV CTD/Raw/SBE19plus_01907947_2022_10_19_0001.hex&#39;</span>
<span class="c1">#     #relpath_hex = &#39;FBCT1 CTD/Raw/SBE16plus_01650406_2022_10_04.hex&#39;</span>
<span class="c1">#     #relpath_hex = &#39;DeckSamplingSBE/decksmpl_return03.hex&#39;</span>
    
<span class="c1">#     filepath_xml = os.path.join(scriptpath,relpath_xml)</span>
<span class="c1">#     filepath_hex = os.path.join(scriptpath,relpath_hex)</span>
    
<span class="c1">#     test = SeabirdCTD(filepath_hex, filepath_xml)</span>
    
<span class="c1">#     #print(test.number_samples)</span>
<span class="c1">#     #print(test.data)</span>
<span class="c1">#     #print(test.coefficients_xml)</span>
<span class="c1">#     #test.dataframe2csv()</span>
    
<span class="c1"># ###############################################################################</span>

<span class="c1"># if __name__ == &#39;__main__&#39;:</span>
<span class="c1">#     main()</span>
    
<span class="c1">###############################################################################</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, anba.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>